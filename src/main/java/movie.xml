<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="moviens">
	<!-- 홈에서 영화 검색 -->
	<select id="search" parameterType="string" resultType="movie">
		select m.* from movie m, tag t where m.movieno = t.movieno and (moviename like '%'||#{searchWord}||'%' 
																	or director like '%'||#{searchWord}||'%' 
																	or genre like '%'||#{searchWord}||'%' 
																	or tag like '%'||#{searchWord}||'%')
		union select m.* from movie m, actor a where m.movieno = a.movieno and actorname like '%'||#{searchWord}||'%'
	</select>
	
	<!-- 영화 상세 정보 -->
	<select id="show" parameterType="integer" resultType="movie">
		select * from movie where movieno = #{movieno}
	</select>
	
	<!-- DB에 등록된 총 영화 갯수 -->
	<select id="getTotal" resultType="integer">
		select count(*) from movie
	</select>
	
	<!-- 영화 리스트 뽑아오기 -->
	<select id="list" parameterType="map" resultType="movie">
		select * from (select rowNum rn, a.* from (select * from movie order by movieno) a)
			where rn between #{startRow} and #{endRow}
	</select>
	
	<!-- DB에 영화 넣기 -->
	<insert id="insert" parameterType="movie">
		<selectKey keyProperty="movieno" order="BEFORE" resultType="integer">
			select nvl(max(movieno), 0)+1 movieno from movie
		</selectKey>
		insert into movie values(#{movieno}, #{moviename}, #{story},
			#{director}, #{playtime},
			#{netflix}, #{disney}, #{coupang}, #{tving},
			#{genre}, 0, #{poster}, #{trailer})
	</insert>
	
	<!-- 영화정보 수정 -->
	<update id="update" parameterType="movie">
		update movie set moviename=#{moviename}, story=#{story}, director=#{director},
			playtime=#{playtime}, netflix=#{netflix}, disney=#{disney},
			coupang=#{coupang}, tving=#{tving}, genre=#{genre},
			<if test="poster != null and poster != ''">
				poster=#{poster},
			</if>
			trailer=#{trailer} where movieno=#{movieno}	
	</update>
	
	<!-- 조회수 TOP10 리스트 조회 -->
	<select id="hotList" resultType="movie">
		select m.*, rowNum from movie m where rowNum <![CDATA[<=]]> 10 order by cnt desc
	</select>
	
	<!-- 조회수 증가 -->
	<update id="readCount" parameterType="integer">
		update movie set cnt = #{cnt}+1 where movieno = #{movieno}
	</update>
	
</mapper>